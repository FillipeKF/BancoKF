<!DOCTYPE html>
<html lang="pt-BR">
<head>

<meta charset="UTF-8">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root { 
    --bg: #0f1115; 
    --card: #1b1e24; 
    --primary: #0d6efd; 
    --success: #16a34a; 
    --text: #94a3b8; 
    --danger: #ef4444;
    --border: #333;
}

/* Remover efeito azul ao tocar no mobile */
* {
    -webkit-tap-highlight-color: transparent; /* Safari e Chrome mobile */
    -webkit-touch-callout: none; /* desabilita menu ao segurar */
}


body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin:0; padding:20px; color:#fff; }
.header-main { background: linear-gradient(90deg,#0b2b6f,#0f4cb8); text-align:center; padding:20px; font-size:24px; font-weight:bold; border-radius:12px; margin-bottom:30px; border-bottom: 4px solid var(--primary); }

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Dropdown de Selecionar Equipe come√ßa fechado */
#fOptions {
    display: none; /* come√ßa fechado */
    position: absolute;
    background: #1b1e24;
    border: 1px solid #444;
    padding: 5px;
    z-index: 10;
}


.card-acao { background: var(--card); padding: 20px; border-radius: 16px; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid var(--border); position: relative; font-size:14px; }
.card-acao:hover { border-color: var(--primary); transform: translateY(-3px); }
.badge-funcionarios { position:absolute; top:10px; left:10px; background:var(--success); color:white; font-weight:bold; padding:5px 10px; border-radius:12px; font-size:12px; display:none; }

.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; overflow-y: auto; padding: 20px; backdrop-filter: blur(5px); }
.container-modal { max-width: 500px; background: var(--card); padding: 25px; border-radius: 18px; margin: 20px auto; position: relative; border: 1px solid #444; }
.btn-fechar { position: absolute; top: 15px; right: 20px; font-size: 25px; color: #ef4444; cursor: pointer; }

label { display:block; margin-top:15px; font-weight:bold; color: var(--text); font-size: 14px; }
input, select, .btn-acao, .multi-display, textarea { width:100%; padding:12px; margin-top:8px; border-radius:10px; background:#2a2e36; color:#fff; border:1px solid #444; box-sizing: border-box; }

.multi-display { cursor: pointer; user-select: none; }
.func-item { padding:12px; cursor:pointer; display:flex; align-items:center; gap:10px; user-select: none; }
.func-item:hover { background: #333a45; }
.func-item.active { background: #0d6efd33; color: #0d6efd; font-weight: bold; }

.btn-acao { background: var(--primary); border:none; font-weight:bold; color: white; cursor:pointer; margin-top:20px; }
.btn-finalizar { background: var(--success); }

#previewFotos { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
.img-preview { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid var(--primary); cursor:pointer; transition: transform 0.2s; }
.img-preview:hover { transform: scale(1.1); }

.toast-container { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--success); color: white; padding: 25px 40px; border-radius: 20px; z-index: 10001; text-align: center; border: 2px solid #22c55e; }
@keyframes zoomIn { from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
.animar-entrada { animation: zoomIn 0.3s ease-out forwards; }

.img-modal { position: fixed; top:50%; left:50%; transform: translate(-50%,-50%); max-width:80%; max-height:80%; background: #1b1e24; border-radius:12px; z-index:10002; display:none; padding:15px; box-sizing:border-box; flex-direction:column; align-items:center; }
.img-modal img { max-width:100%; max-height:400px; border-radius:12px; margin-bottom:10px; }
.img-modal .modal-btns { display:flex; gap:10px; }
.img-modal button { padding:5px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; color:white; }
.btn-download { background:#0d6efd; }
.btn-fechar-img { background:#ef4444; }

.card-lista { background: #252a33; padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 5px solid var(--primary); position: relative; cursor:pointer; font-size:13px; display:flex; flex-direction:column; justify-content:center; min-width:200px; max-width:240px; }

.card-concluido { border-left-color: var(--success); opacity: 0.9; }

#listaAndamento, #listaHistorico { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; max-height: 600px; overflow-y: auto; padding: 10px; }

.card-pintura { border-left: 5px solid #ef4444; background:#331b1b; }
.card-eletrica { border-left: 5px solid #facc15; background:#332b1b; }
.card-hidraulica { border-left: 5px solid #0d6efd; background:#1b2233; }
.card-civil { border-left: 5px solid #a855f7; background:#2a1b33; }

.desenvolvido { text-align: right; font-size: 14px; color: var(--text); margin-top: 5px; font-weight: normal; }

/* MEDIA QUERIES */
@media (max-width: 1024px) {
    .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin: 20px; }
    .card-lista { min-width: 160px; max-width: 200px; }
    .header-main { font-size: 22px; padding: 15px; }
}

@media (max-width: 768px) {
    body { padding:10px; }
    .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 10px; }
    .card-lista { min-width: 140px; max-width: 180px; font-size: 12px; padding: 10px; }
    #listaAndamento, #listaHistorico { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .header-main { font-size: 20px; padding: 12px; }
    input, select, textarea, .btn-acao { padding: 10px; font-size: 13px; }
    .img-preview { width: 60px; height: 60px; }
}

@media (max-width: 480px) {
    .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 5px; }
    .card-lista { min-width: 120px; max-width: 160px; font-size: 11px; padding: 8px; }
    .header-main { font-size: 18px; padding: 10px; }
    .img-preview { width: 50px; height: 50px; }
}

.desenvolvido {
    text-align: right;
    font-size: 14px;
    color: var(--text);
    margin-top: 5px;  /* Pequeno espa√ßamento em rela√ß√£o ao t√≠tulo */
    font-weight: normal;
}


.modal *:focus {
    outline: none;  /* remove contorno azul ao focar */
    box-shadow: none; /* remove sombra de foco */
}
@media (hover:none) {
    .card-acao:hover {
        transform: none; /* remove hover no touch */
    }
}

/* ------------------- CAMADA DE LOGIN ------------------- */
#loginOverlay {
  position: fixed;
  inset: 0;
  background: rgba(15,17,21,0.95);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
}

.loginBox {
  background: var(--card);
  padding: 30px;
  border-radius: 16px;
  width: 300px;
  text-align: center;
  border: 1px solid var(--border);
  box-shadow: 0 0 25px rgba(0,0,0,0.5);
}

.loginBox input {
  margin-top: 10px;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #444;
  width: 100%;
  background: #2a2e36;
  color: #fff;
}

.loginBox button {
  margin-top: 15px;
  padding: 10px;
  width: 100%;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}

#loginError {
  color: var(--danger);
  margin-top: 10px;
  display: none;
  font-size: 14px;
}

#modalRestore .container-modal img,
#modalFotos .container-modal img {
    width: 100%;
    max-width: 90px;
    height: auto;
    object-fit: cover;
    border-radius: 8px;
}


@media (max-width: 480px) {
    .modal .container-modal {
        width: 98%;
        max-width: 98%;
        padding: 15px;
    }
}
/* Conte√∫do principal (inicialmente acess√≠vel, overlay bloqueia visual) */
#mainContent { display: block; }


</style>
</head>
<body>

    <!-- ------------------- LOGIN OVERLAY ------------------- -->
<div id="loginOverlay">
  <div class="loginBox">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Usu√°rio">
    <input type="password" id="password" placeholder="Senha">
    <button id="loginBtn">Entrar</button>
    <p id="loginError"></p>
  </div>
</div>

<div id="toastSucesso" class="toast-container">
    <span style="font-size:50px">‚úÖ</span>
    <div id="toastTexto" style="font-size:18px; font-weight:bold; margin-top:10px">Sucesso!</div>
</div>

<!-- TOAST GEN√âRICO PARA ALMOXARIFADO -->
<div id="toastAlmoxarifado" class="toast-container" style="background:#16a34a;">
    <span style="font-size:30px">‚úÖ</span>
    <div id="toastAlmoxarifadoTexto" style="font-size:16px; font-weight:bold; margin-top:5px">Sucesso!</div>
</div>

<div class="header-main">KF ENGENHARIA - CAMPO</div>
<div class="desenvolvido">Desenvolvido por Fillipe Leal</div>
<div class="dashboard-grid">
    <div class="card-acao" onclick="abrirModal('modalCadastro')">
        <div style="font-size:40px">üìù</div>
        <h3>Registrar Atividade</h3>
    </div>

    <div class="card-acao" onclick="abrirEquipe()">
        <div id="badgeFuncionarios" class="badge-funcionarios hidden">0 Funcion√°rios</div>
        <div style="font-size:40px">üë∑</div>
        <h3>Equipe em Campo</h3>
    </div>

    <div class="card-acao" onclick="abrirHistorico()">
        <div style="font-size:40px">üóÑÔ∏è</div>
        <h3>CIs Registradas</h3>
    </div>

  <div class="card-acao" onclick="abrirAlmoxarifado()">
    <div style="font-size:40px">üì¶</div>
    <h3>Almoxarifado</h3>
</div>
</div>

<!-- MODAL CADASTRO -->
<div id="modalCadastro" class="modal">
    <div class="container-modal">
        <span class="btn-fechar" onclick="fecharModal('modalCadastro')">&times;</span>
        <h2 style="color:var(--primary)">Nova Atividade</h2>

        <label>Equipe</label>
        <div style="position:relative">
            <div class="multi-display" id="fDisplay" onclick="toggleFuncs(event)">Selecionar Equipe</div>
            <div class="hidden" id="fOptions" style="position:absolute; width:100%; background:#1e293b; z-index:10; border-radius:10px; border:1px solid #444; max-height:150px; overflow-y:auto;">
                <div class="func-item" onclick="selectFunc(this, 'Fillipe', event)">Fillipe</div>
                <div class="func-item" onclick="selectFunc(this, 'Luiz', event)">Luiz</div>
                <div class="func-item" onclick="selectFunc(this, 'Frank', event)">Frank</div>
                <div class="func-item" onclick="selectFunc(this, 'Marcelo', event)">Marcelo</div>
                 <div class="func-item" onclick="selectFunc(this, 'Rogerio', event)">Rogerio</div>
                  <div class="func-item" onclick="selectFunc(this, 'Wiliam', event)">Wiliam</div>
                <div class="func-item" onclick="selectFunc(this, 'Nadao', event)">Nadao</div>
                   <div class="func-item" onclick="selectFunc(this, 'Lorao', event)">Lorao</div>
                      <div class="func-item" onclick="selectFunc(this, 'Soneca', event)">Soneca</div>
                         <div class="func-item" onclick="selectFunc(this, 'Mirim', event)">Mirim</div>
                               <div class="func-item" onclick="selectFunc(this, 'Junior', event)">Junior</div>
                            <div class="func-item" onclick="selectFunc(this, 'Elio', event)">Elio</div>
                                  <div class="func-item" onclick="selectFunc(this, 'Vicente', event)">Vicente</div>
                                     <div class="func-item" onclick="selectFunc(this, 'Paulo', event)">Paulo</div>
                                      <div class="func-item" onclick="selectFunc(this, 'DanielEnc', event)">DanielEnc</div>
                                       <div class="func-item" onclick="selectFunc(this, 'AmareloEnc', event)">AmareloEnc</div>
                                        <div class="func-item" onclick="selectFunc(this, 'RafaelEnc', event)">RafaelEnc</div>
                                         <div class="func-item" onclick="selectFunc(this, 'MarcoEnc', event)">MarcoEnc</div>

            </div>
        </div>

        <label>Servi√ßo</label>
        <select id="fAtividade">
            <option value="Pintura">Pintura</option>
            <option value="Eletrica">Eletrica</option>
            <option value="Hidraulica">Hidraulica</option>
            <option value="Civil">Civil</option>
        </select>

        <label>Local</label>
        <select id="fTipoLocal" onchange="atualizarLocais()">
            <option value="" disabled selected>Selecionar</option>
            <option value="Setor">Setor</option>
            <option value="Regional">Regional</option>
        </select>
        <div id="areaSubLocal" class="hidden">
            <label>Ponto Espec√≠fico</label>
            <select id="fSubLocal"></select>
        </div>

        <label>N√∫mero da CI</label>
        <input type="text" id="fCI" placeholder="Ex: 001/2024">

        <button class="btn-acao" onclick="iniciarAtividade()">Confirmar In√≠cio</button>
    </div>
</div>

<!-- MODAL EQUIPE -->
<div id="modalEquipe" class="modal">
    <div class="container-modal">
        <span class="btn-fechar" onclick="fecharModal('modalEquipe')">&times;</span>
        <h2 style="color:var(--primary)">Equipe em Campo</h2>
        <div id="listaAndamento"></div>
    </div>
</div>

<!-- MODAL ALMOXARIFADO -->
<div id="modalAlmoxarifado" class="modal">
    <div class="container-modal">
        <span class="btn-fechar" onclick="fecharModal('modalAlmoxarifado')">&times;</span>
        <h2 style="color:var(--primary)">Registrar Item</h2>

        <label>Nome do Item</label>
        <input type="text" id="itemNome" placeholder="Ex: Tinta Branca">

        <label>Quantidade</label>
        <input type="number" id="itemQuantidade" placeholder="Ex: 10">

        <label>Setor</label>
        <select id="itemSetor">
            <option value="" disabled selected>Selecionar Setor</option>
            <option value="Pintura">Pintura</option>
            <option value="El√©trica">El√©trica</option>
            <option value="Hidr√°ulica">Hidr√°ulica</option>
            <option value="Civil">Civil</option>
        </select>

        <button class="btn-acao" onclick="registrarItem()">Registrar Item</button>



        <h3 style="margin-top:20px; color:var(--text)">Itens Registrados</h3>
          <!-- FILTRO ACIMA DA TABELA -->
        <div style="margin-top:20px; margin-bottom:10px;">
            <label style="color:var(--text); font-weight:bold; font-size:13px;">Filtrar por Setor:</label>
            <select id="filtroSetorItens" onchange="atualizarListaItens()" 
                    style="width:100%; padding:5px; border-radius:6px; background:#2a2e36; color:#fff; border:1px solid #444;">
                <option value="">Todos</option>
                <option value="Pintura">Pintura</option>
                <option value="El√©trica">El√©trica</option>
                <option value="Hidr√°ulica">Hidr√°ulica</option>
                <option value="Pedreiro">Pedreiro</option>
            </select>
        </div>
        <div style="max-height:300px; overflow-y:auto; border:1px solid #444; border-radius:12px;">
            <table id="tabelaItens" style="width:100%; border-collapse: collapse; margin-top:10px; font-size:13px; color:#fff;">
                <thead>
                    <tr style="background:#1b1e24;">
                        <th style="padding:10px; border:1px solid #444; text-align:left;">Nome do Item</th>
                        <th style="padding:10px; border:1px solid #444; width:80px;">Quantidade</th>
                        <th style="padding:10px; border:1px solid #444; width:120px;">Setor</th>
                        <th style="padding:10px; border:1px solid #444; width:80px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="listaItens">
                    <!-- Itens v√£o aqui -->
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- POPUP EDITAR ITEM -->
<div id="modalEditarItem" class="modal">
    <div class="container-modal">
        <span class="btn-fechar" onclick="fecharModal('modalEditarItem')">&times;</span>
        <h2 style="color:var(--primary)">Editar Item</h2>

        <label>Nome do Item</label>
        <input type="text" id="editItemNome">

        <label>Quantidade</label>
        <input type="number" id="editItemQuantidade">

        <label>Setor</label>
        <select id="editItemSetor">
            <option value="Pintura">Pintura</option>
            <option value="El√©trica">El√©trica</option>
            <option value="Hidr√°ulica">Hidr√°ulica</option>
            <option value="Civil">Civil</option>
        </select>

        <button class="btn-acao" onclick="confirmarEdicaoItem()">Salvar Altera√ß√µes</button>
    </div>
</div>

<!-- POPUP EXCLUIR ITEM -->
<div id="modalExcluirItem" class="modal">
    <div class="container-modal">
        <span class="btn-fechar" onclick="fecharModal('modalExcluirItem')">&times;</span>
        <h2 style="color:var(--danger)">Excluir Item</h2>
        <p>Deseja realmente excluir este item?</p>
        <button class="btn-acao" style="background:#ef4444;" onclick="confirmarExclusaoItem()">Sim</button>
        <button class="btn-acao" style="background:#555;" onclick="fecharModal('modalExcluirItem')">N√£o</button>
    </div>
</div>
<!-- MODAL HIST√ìRICO -->
<div id="modalHistorico" class="modal">
    <div class="container-modal">
        <span class="btn-fechar" onclick="fecharModal('modalHistorico')">&times;</span>
        <h2 style="color:var(--success)">CIs Registradas</h2>

      <!-- FILTROS CIs REGISTRADAS -->
<div id="filtrosHistorico" style="display:flex; gap:15px; margin-bottom:15px; align-items:center; flex-wrap:wrap;">
    <!-- Filtro por Data -->
    <div>
        <label style="color:var(--text); font-weight:bold; font-size:13px;">Filtrar por Data:</label>
        <div style="display:flex; gap:5px;">
            <!-- Dia -->
            <select id="filtroDiaHistorico" onchange="atualizarHistorico()">
                <option value="">Dia</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="22">22</option>
                <option value="23">23</option>
                <option value="24">24</option>
                <option value="25">25</option>
                <option value="26">26</option>
                <option value="27">27</option>
                <option value="28">28</option>
                <option value="29">29</option>
                <option value="30">30</option>
                <option value="31">31</option>
            </select>

            <!-- M√™s -->
            <select id="filtroMesHistorico" onchange="atualizarHistorico()">
                <option value="">M√™s</option>
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Mar√ßo</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>

            <!-- Ano -->
            <select id="filtroAnoHistorico" onchange="atualizarHistorico()">
                <option value="">Ano</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
                <option value="2030">2030</option>
                <option value="2031">2031</option>
                <option value="2032">2032</option>
                <option value="2033">2033</option>
                <option value="2034">2034</option>
                <option value="2035">2035</option>
                <option value="2036">2036</option>
                <option value="2037">2037</option>
                <option value="2038">2038</option>
                <option value="2039">2039</option>
                <option value="2040">2040</option>
                <option value="2041">2041</option>
                <option value="2042">2042</option>
                <option value="2043">2043</option>
                <option value="2044">2044</option>
                <option value="2045">2045</option>
                <option value="2046">2046</option>
                <option value="2047">2047</option>
                <option value="2048">2048</option>
                <option value="2049">2049</option>
                <option value="2050">2050</option>
            </select>
        </div>
    </div>

    <!-- Filtro por fun√ß√£o/servi√ßo -->
    <div>
        <label style="color:var(--text); font-weight:bold; font-size:13px;">Filtrar por Servi√ßo:</label>
        <select id="filtroServicoHistorico" onchange="atualizarHistorico()">
            <option value="">Todos</option>
            <option value="Pintura">Pintura</option>
            <option value="El√©trica">El√©trica</option>
            <option value="Hidr√°ulica">Hidr√°ulica</option>
            <option value="Civil">Pedreiro</option>
        </select>
    </div>
</div>
 <!-- BOT√ïES DE BACKUP E RESTORE -->
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
            <button class="btn-acao" style="background:#0d6efd;" onclick="backupCIsDoMes()">üíæ Backup CIs</button>
            <button class="btn-acao" style="background:#16a34a;" onclick="restaurarCIs()">üìÇ Restaurar CIs</button>
        </div>

        <div id="listaHistorico"></div>
    </div>
</div>
<!-- MODAL EDITAR ATIVIDADE -->
<div id="modalEditarAtividade" class="modal">
    <div class="container-modal">
        <span class="btn-fechar" onclick="fecharModal('modalEditarAtividade')">&times;</span>
        <h2 style="color:#f59e0b">Editar Atividade</h2>

        <label>CI:</label>
        <input type="text" id="editCi">

        <label>Servi√ßo:</label>
        <input type="text" id="editServico">

        <label>Local:</label>
        <input type="text" id="editLocal">

        <label>Equipe (separado por v√≠rgula):</label>
        <input type="text" id="editEquipe">

        <button onclick="salvarEdicaoAtividade()" 
                style="background:#0d6efd; color:white; border:none; padding:6px 12px; border-radius:6px; margin-top:10px; cursor:pointer;">
            Salvar Edi√ß√£o
        </button>
    </div>
</div>


<!-- MODAL FINALIZAR -->
<!-- MODAL FINALIZAR -->
<div id="modalFinalizar" class="modal">
    <div class="container-modal">
        <span class="btn-fechar" onclick="fecharModal('modalFinalizar')">&times;</span>
        <h2 style="color:var(--success)">Concluir Trabalho</h2>

        <div id="detalhesServico" style="padding:10px; background:#16191f; border-radius:10px; margin-bottom:15px; font-size:13px;"></div>

        <!-- BOT√ÉO EDITAR CI -->
        <button id="btnEditarCi" 
                style="background:#f59e0b; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; margin-bottom:10px;"
                onclick="abrirModalEdicao()">‚úèÔ∏è Editar CI</button>

        <label>Fotos da Conclus√£o</label>
        <input type="file" id="fFotos" multiple accept="image/*" onchange="previewImages(this)">
        <div id="previewFotos"></div>

        <label>Descri√ß√£o / Observa√ß√µes</label>
        <textarea id="fRelato" rows="3" placeholder="Relate o que foi feito..."></textarea>

        <button class="btn-acao btn-finalizar" onclick="finalizarAtividade()">Finalizar e Sincronizar</button>
    </div>
</div>

<!-- MODAL RESTORE -->
<!-- MODAL RESTORE -->
<div id="modalRestore" class="modal" style="display:none;">
  <div class="container-modal" style="width:95%; max-width:900px; max-height:85vh; overflow-y:auto;">
    <span class="btn-fechar" onclick="fecharModal('modalRestore')">&times;</span>
    <h2 style="color:var(--success)">Restaurar CIs do Backup</h2>
    <div id="listaCIs"></div>
  </div>
</div>

<!-- MODAL FOTOS -->
<div id="modalFotos" class="modal" style="display:none;">
  <div class="container-modal" style="
      width:95%; 
      max-width:900px; 
      max-height:85vh; 
      overflow-y:auto; 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      justify-content:flex-start;
      padding:20px;
  ">
    <span class="btn-fechar" onclick="fecharModal('modalFotos')">&times;</span>
    <h2 style="color:var(--success); margin-bottom:15px;">Fotos da CI</h2>
    <div id="listaFotos" style="
        display:flex; 
        flex-wrap:wrap; 
        gap:10px; 
        justify-content:center;
        align-items:center;
        width:100%;
    "></div>
  </div>
</div>

<!-- MODAL IMAGEM -->
<div id="modalImagem" class="img-modal">
    <img id="imgGrande" src="">
    <div class="modal-btns">
        <button class="btn-download" onclick="baixarImagem()">‚¨áÔ∏è Download</button>
        <button class="btn-fechar-img" onclick="fecharModal('modalImagem')">‚úñ Fechar</button>
    </div>
</div>



<script>
let selecionados = [];
let atividadesAtivas = [];
let atividadesConcluidas = [];
let atividadeAtual = null;
let imagemAtual = "";
let itensRegistrados = [];
let itemAtualEditar = null;
let itemAtualExcluir = null;



// URL base da API
const API_BASE = "https://bancokf.onrender.com";
// MODAIS
// ======================= MODAIS =======================



const loginOverlay = document.getElementById("loginOverlay");
const loginBtn = document.getElementById("loginBtn");
const loginError = document.getElementById("loginError");





loginBtn.addEventListener("click", async () => {
  const usuario = document.getElementById("username").value;
  const senha = document.getElementById("password").value;

  if(!usuario || !senha){
    loginError.style.display = "block";
    loginError.innerText = "Preencha usu√°rio e senha";
    return;
  }

  try {
    // Chama a rota do seu backend que valida no PostgreSQL/Supabase
   // üîπ URL do backend Render (onde seu app Node.js est√° hospedado)
const BACKEND_URL = "https://bancokf.onrender.com"; // <- n√£o √© SUPABASE_URL

const res = await fetch(`${BACKEND_URL}/login`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ usuario, senha })
});

    const data = await res.json();

    if (data.ok) {
      loginOverlay.style.display = "none"; // remove overlay
    } else {
      loginError.style.display = "block";
      loginError.innerText = data.error || "Usu√°rio ou senha incorretos";
    }

  } catch(err) {
    console.error(err);
    loginError.style.display = "block";
    loginError.innerText = "Erro de conex√£o com o servidor";
  }
});

function abrirModal(id){ document.getElementById(id).style.display='block'; }
function fecharModal(id){ document.getElementById(id).style.display='none'; }



// ------------------- BACKUP CIs -------------------
// ------------------- BACKUP CIs -------------------

async function backupCIsDoMes() {
    try {
        const month = document.getElementById('filtroMesHistorico').value;
        const year = document.getElementById('filtroAnoHistorico').value;

        if (!month || !year) {
            alert("Selecione m√™s e ano para o backup");
            return;
        }

        const res = await fetch(`${API_BASE}/atividades/backup?mes=${month}&ano=${year}`);
        if (!res.ok) throw "Erro ao buscar CIs";

        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
            alert("N√£o h√° CIs nesse per√≠odo");
            return;
        }

        const zip = new JSZip();

        for (const ci of data) {

            // TXT da CI
           const pastaCI = zip.folder(`CI_${ci.id}_${ci.inicio}`);

pastaCI.file("dados.txt", JSON.stringify(ci, null, 2));


            // ===============================
            // GARANTE ARRAY REAL DE FOTOS
            // ===============================
            let fotos = [];

            try {
                fotos = Array.isArray(ci.fotos) ? ci.fotos : JSON.parse(ci.fotos || "[]");
            } catch {
                fotos = [];
            }

            // ===============================
            // BAIXA FOTOS COM BLINDAGEM
            // ===============================
            if (fotos.length > 0) {

                const folderFotos = pastaCI.folder("fotos");

                for (let i = 0; i < fotos.length; i++) {

                    let foto = String(fotos[i])
                        .replace("[", "")
                        .replace("]", "")
                        .replace(/"/g, "")
                        .trim();

                    if (!foto.startsWith("http")) {
                        console.warn("Foto ignorada:", foto);
                        continue;
                    }

                    try {
                        const fotoBlob = await fetch(foto).then(r => r.blob());
                        folder.file(`foto${i + 1}.jpg`, fotoBlob);
                    } catch (e) {
                        console.warn("Erro ao baixar:", foto);
                        continue;
                    }
                }
            }
        }

        // ===============================
        // GERA ZIP
        // ===============================
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, `backup_CI_${month}-${year}.zip`);

        // ===============================
        // APAGA DO SERVIDOR
        // ===============================
        if (confirm("Backup conclu√≠do! Deseja apagar essas CIs do servidor?")) {

            const ids = data.map(c => c.id);

            await fetch(`${API_BASE}/atividades/apagar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ids })
            });

            alert("CIs apagadas do servidor!");
            atualizarHistorico();
        }

    } catch (err) {
        console.error(err);
        alert("Erro no backup: " + err);
    }
}

// ------------------- RESTORE CIs TEMPOR√ÅRIO -------------------
async function restaurarCIs() {

    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".zip";

    input.onchange = async (e) => {

        const file = e.target.files[0];
        if (!file) return;

        const zip = await JSZip.loadAsync(file);

        const cis = [];

        for (const path in zip.files) {

            if (path.endsWith(".txt")) {

                const pasta = path.replace(".txt", "");

                const text = await zip.file(path).async("string");
                const ci = JSON.parse(text);

                ci.__pasta = pasta;

                cis.push(ci);
            }
        }

        abrirModalRestore(cis, zip);
    };

    input.click();
}




// ------------------- MODAL TEMPOR√ÅRIO DE RESTORE -------------------
function abrirModalRestore(cis, zip) {
    const listaCIs = document.getElementById("listaCIs");
    if(!listaCIs) return console.error("Elemento listaCIs n√£o encontrado");

    listaCIs.innerHTML = "";

    cis.forEach(ci => {
        const bloco = document.createElement("div");
        bloco.style.background = "#252a33";
        bloco.style.borderRadius = "10px";
        bloco.style.padding = "12px";
        bloco.style.marginBottom = "15px";
        bloco.style.cursor = "pointer";

        const h = document.createElement("h3");
        h.style.color = "var(--success)";
        h.textContent = `CI ${ci.ci} ‚Äî ${new Date(ci.inicio).toLocaleDateString()}`;
        bloco.appendChild(h);

        const detalhes = document.createElement("div");
        detalhes.style.background = "#16191f";
        detalhes.style.borderRadius = "10px";
        detalhes.style.padding = "10px";
        detalhes.style.fontSize = "13px";
        detalhes.style.marginTop = "5px";
        detalhes.innerHTML = `
<b>Servi√ßo:</b> ${ci.servico}<br>
<b>Equipe:</b> ${ci.equipe}<br>
<b>In√≠cio:</b> ${new Date(ci.inicio).toLocaleString()}<br>
<b>Fim:</b> ${ci.fim ? new Date(ci.fim).toLocaleString() : "-"}<br>
<b>Relato:</b> ${ci.relato || "-"}
`;
        bloco.appendChild(detalhes);

        bloco.onclick = () => abrirModalFotos(ci, zip);

        listaCIs.appendChild(bloco);
    });

    const modal = document.getElementById("modalRestore");
    if(modal) modal.style.display = "flex";
}

function abrirModalFotos(ci, zip) {
    const listaFotos = document.getElementById("listaFotos");
    if(!listaFotos) return console.error("Elemento listaFotos n√£o encontrado");

    listaFotos.innerHTML = "";

    const fotosDiv = document.createElement("div");
    fotosDiv.style.display = "flex";
    fotosDiv.style.flexWrap = "wrap";
    fotosDiv.style.gap = "10px";
    fotosDiv.style.justifyContent = "center";

    Object.keys(zip.files).forEach(async filePath => {
        if(filePath.startsWith(ci.__pasta + "/fotos/")) {
            const file = zip.file(filePath);
            if(!file) return;

            const blob = await file.async("blob");
            const img = document.createElement("img");
            img.src = URL.createObjectURL(blob);
            img.style.width = "80px";
            img.style.height = "80px";
            img.style.objectFit = "cover";
            img.style.borderRadius = "8px";

            fotosDiv.appendChild(img);
        }
    });

    listaFotos.appendChild(fotosDiv);

    const modal = document.getElementById("modalFotos");
    if(modal) modal.style.display = "flex";
}

function fecharModal(id) {
    const modal = document.getElementById(id);
    if(modal) modal.style.display = "none";
}


function normalizar(texto) {
    return texto
        ?.normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toLowerCase();
}


function agoraISO(){
    return new Date().toISOString();
}

function formatarBR(dataISO){
    return new Date(dataISO).toLocaleString("pt-BR");
}
// Abrir modal j√° existente
function abrirAlmoxarifado() {
    abrirModal('modalAlmoxarifado');
carregarItens();
}// Registrar novo item
async function registrarItem() {
    const nome = document.getElementById('itemNome').value.trim();
    const quantidade = parseInt(document.getElementById('itemQuantidade').value);
    const setor = document.getElementById('itemSetor').value;

    if (!nome || !quantidade || !setor) {
        alert("Preencha todos os campos!");
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/itens`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nome, quantidade, setor })
        });

        const contentType = res.headers.get("content-type") || "";
        if (!contentType.includes("application/json")) {
            const text = await res.text();
            console.error("Resposta inesperada do backend:", text);
            throw "Resposta do servidor n√£o √© JSON. Verifique a URL/API_BASE.";
        }

        await res.json();

        // Limpa inputs
        document.getElementById('itemNome').value = "";
        document.getElementById('itemQuantidade').value = "";
        document.getElementById('itemSetor').value = "";

        mostrarToast("Item salvo no banco!");
        carregarItens();

    } catch (err) {
        alert("Falha ao salvar item: " + err);
        console.error(err);
    }
}
// 2Ô∏è‚É£ Carregar itens do backend
async function carregarItens() {
    try {
        const res = await fetch(`${API_BASE}/itens`);
        const data = await res.json();
        itensRegistrados = data;
        atualizarListaItens();
    } catch (err) {
        console.error("Erro ao carregar itens:", err);
    }
}
// 3Ô∏è‚É£ Atualizar lista HTML
function atualizarListaItens() {
    const tbody = document.getElementById('listaItens');
    tbody.innerHTML = "";

    const filtroSetor = document.getElementById('filtroSetorItens').value;
    let itensFiltrados = itensRegistrados;

    if(filtroSetor) {
        itensFiltrados = itensRegistrados.filter(item => normalizar(item.setor) === normalizar(filtroSetor));
    }

    if (itensFiltrados.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" style="padding:10px; text-align:center;">Nenhum item registrado.</td>`;
        tbody.appendChild(tr);
        return;
    }

    const corSetor = {
        pintura: "#ef4444",
        eletrica: "#facc15",
        hidraulica: "#0d6efd",
        civil: "#a855f7"
    };

    itensFiltrados.forEach(item => {
        const tr = document.createElement('tr');
        const setorKey = normalizar(item.setor);

        tr.style.borderLeft = `5px solid ${corSetor[setorKey] || '#0d6efd'}`;
        tr.style.background = "#252a33";
        tr.style.color = "#fff";

        tr.innerHTML = `
            <td style="padding:10px; border:1px solid #444;">${item.nome}</td>
            <td style="padding:10px; border:1px solid #444; text-align:center;">${item.quantidade}</td>
            <td style="padding:10px; border:1px solid #444; text-align:center;">${item.setor}</td>
            <td style="padding:10px; border:1px solid #444; text-align:center;">
                <span style="cursor:pointer; color:#0d6efd; font-weight:bold; margin-right:5px;" onclick="editarItem(${item.id})">‚úèÔ∏è</span>
                <span style="cursor:pointer; color:#ef4444; font-weight:bold;" onclick="excluirItem(${item.id})">üóëÔ∏è</span>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
// 4Ô∏è‚É£ Editar Item
function editarItem(id) {
    const item = itensRegistrados.find(i => i.id === id);
    if (!item) return;

    itemAtualEditar = item;
    document.getElementById('editItemNome').value = item.nome;
    document.getElementById('editItemQuantidade').value = item.quantidade;
    document.getElementById('editItemSetor').value = item.setor;

    abrirModal('modalEditarItem');
}

// Fun√ß√£o auxiliar para normalizar texto
function normalizar(texto) {
    return texto
        ?.normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toLowerCase();
}
// Substitui confirm antigo
// 6Ô∏è‚É£ Excluir Item
async function excluirItem(id) {
    if (!confirm("Deseja realmente excluir este item?")) return;

    try {
        const res = await fetch(`${API_BASE}/itens/${id}`, { method: "DELETE" });

        const contentType = res.headers.get("content-type") || "";
        if (!contentType.includes("application/json")) {
            const text = await res.text();
            console.error("Resposta inesperada do backend:", text);
            throw "Resposta do servidor n√£o √© JSON. Verifique a URL/API_BASE.";
        }

        const data = await res.json();
        if (!data.ok) throw data.error || "Erro ao excluir item";

        itensRegistrados = itensRegistrados.filter(i => i.id !== id);
        atualizarListaItens();
        mostrarToast("Item exclu√≠do!");

    } catch (err) {
        alert("Falha ao excluir item: " + err);
        console.error(err);
    }
}
function confirmarExclusaoItem() {
    if (!itemAtualExcluir) return;

    fetch(`${API_BASE}/itens/${itemAtualExcluir.id}`, { method: "DELETE" })
    .then(() => {
        mostrarToast("Item exclu√≠do do banco!");
        fecharModal('modalExcluirItem');
        carregarItens();   // recarrega direto do SQLite
        itemAtualExcluir = null;
    })
    .catch(err => console.error(err));
}


// 5Ô∏è‚É£ Confirmar edi√ß√£o (vers√£o final)
async function confirmarEdicaoItem() {
    if (!itemAtualEditar) return;

    const novoNome = document.getElementById('editItemNome').value.trim();
    const novaQuantidade = parseInt(document.getElementById('editItemQuantidade').value);
    const novoSetor = document.getElementById('editItemSetor').value;

    if (!novoNome || !novaQuantidade || !novoSetor) {
        alert("Preencha todos os campos!");
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/itens/${itemAtualEditar.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nome: novoNome, quantidade: novaQuantidade, setor: novoSetor })
        });

        const contentType = res.headers.get("content-type") || "";
        if (!contentType.includes("application/json")) {
            const text = await res.text();
            console.error("Resposta inesperada do backend:", text);
            throw "Resposta do servidor n√£o √© JSON. Verifique a URL/API_BASE.";
        }

        const data = await res.json();
        if (!data.ok) throw data.error || "Erro ao atualizar item";

        // Atualiza local e HTML
        itemAtualEditar.nome = novoNome;
        itemAtualEditar.quantidade = novaQuantidade;
        itemAtualEditar.setor = novoSetor;

        mostrarToast("Item editado!");
        atualizarListaItens();
        fecharModal('modalEditarItem');
        itemAtualEditar = null;

    } catch (err) {
        alert("Falha ao editar item: " + err);
        console.error(err);
    }
}




// ======================= EQUIPES =======================
function toggleFuncs(e){
    e.stopPropagation(); 
    const fOptions = document.getElementById('fOptions');
    if(fOptions.style.display === 'block'){
        fOptions.style.display = 'none'; // fecha
    } else {
        fOptions.style.display = 'block'; // abre
    }
}

// Fecha o dropdown se clicar fora
// Fecha o dropdown se clicar fora
document.addEventListener('click', () => {
    const fOptions = document.getElementById('fOptions');
    fOptions.style.display = 'none';
});

function selectFunc(el,nome,e){
    e.stopPropagation();
    el.classList.toggle('active');
    if(el.classList.contains('active')) selecionados.push(nome);
    else selecionados = selecionados.filter(x=>x!==nome);
    document.getElementById('fDisplay').textContent = selecionados.length ? selecionados.join(", ") : "Selecionar Equipe";
}

// ======================= LOCAIS =======================
function atualizarLocais(){
    const sub=document.getElementById('fSubLocal');
    document.getElementById('areaSubLocal').classList.remove('hidden');
    const opts=document.getElementById('fTipoLocal').value==="Setor" ? ["Cam","Seplag"] : ["Itaipu","Centro"];
    sub.innerHTML = opts.map(x=>`<option value="${x}">${x}</option>`).join('');
}// ======================= TOAST =======================
function mostrarToast(msg){
    const t=document.getElementById('toastSucesso');
    document.getElementById('toastTexto').textContent=msg;
    t.style.display='block';
    t.classList.add('animar-entrada');
    setTimeout(()=>t.style.display='none',2000);
}

// ======================= ATIVIDADES =======================
// Carrega atividades ativas do banco
function carregarAtividades() {

    // LIMPA ARRAYS
    atividadesAtivas = [];
    atividadesConcluidas = [];

    // =====================
    // ATIVAS
    // =====================
 fetch(`${API_BASE}/atividades/ativas`)
        .then(res => res.json())
        .then(data => {
            atividadesAtivas = data;
            atualizarEquipeCampo();
        })
        .catch(err => console.error("Erro ativas:", err));

    // =====================
    // CONCLU√çDAS
    // =====================
  fetch(`${API_BASE}/atividades`)
        .then(res => res.json())
        .then(data => {
            atividadesConcluidas = data;
            atualizarHistorico();
        })
        .catch(err => console.error("Erro conclu√≠das:", err));

}
function iniciarAtividade() {

    const ci = document.getElementById('fCI').value.trim();
    const servico = document.getElementById('fAtividade').value;
    const local = document.getElementById('fSubLocal').value;

    if (!selecionados.length || !ci || !servico || !local) {
        alert("Preencha todos os campos!");
        return;
    }

    const atividade = {
        ci,
        servico,
        local,
        equipe: selecionados.join(","), // backend espera string
        inicio: agoraISO()
    };

    fetch(`${API_BASE}/atividades/inicio`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(atividade)
    })
    .then(async res => {

        if (!res.ok) {
            const t = await res.text();
            throw new Error(t);
        }

        return res.json();
    })
    .then(data => {

        if (!data.id) throw new Error("Backend n√£o retornou ID");

        atividade.id = data.id;
        atividade.relato = "";
        atividade.fotos = [];
        atividade.fim = "";

        atividadesAtivas.push({
            ...atividade,
            equipe: selecionados // volta array no frontend
        });

        limparForm();
        atualizarEquipeCampo();
        mostrarToast("Atividade iniciada!");

    })
    .catch(err => {
        console.error("INICIAR ERRO:", err);
        alert("Falha ao iniciar atividade (veja console)");
    });

}
function dataAgoraBR(){
    return new Date().toLocaleString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    });
}
function limparForm(){
    // Limpa o array de selecionados
    selecionados = [];

    // Reseta o texto do display
    document.getElementById('fDisplay').textContent = "Selecionar Equipe";

    // Remove a classe 'active' de todos os itens
    document.querySelectorAll('#fOptions .func-item').forEach(el => el.classList.remove('active'));

    // Limpa campos adicionais
    document.getElementById('fCI').value = "";
    document.getElementById('fSubLocal').innerHTML = "";
    document.getElementById('areaSubLocal').classList.add('hidden');
    document.getElementById('fAtividade').selectedIndex = 0;
    document.getElementById('fTipoLocal').selectedIndex = 0;
}

// MODAL EQUIPEEDICAO

function abrirModalEdicao() {
    if (!atividadeAtual) return;

    // Fecha modal de finalizar
    fecharModal('modalFinalizar');

    document.getElementById('editCi').value = atividadeAtual.ci;
    document.getElementById('editServico').value = atividadeAtual.servico;
    document.getElementById('editLocal').value = atividadeAtual.local;
    document.getElementById('editEquipe').value = atividadeAtual.equipe.join(", ");

    abrirModal('modalEditarAtividade');
}
function salvarEdicaoAtividade() {
    if (!atividadeAtual) return;

    const novaCi = document.getElementById('editCi').value.trim();
    const novoServico = document.getElementById('editServico').value.trim();
    const novoLocal = document.getElementById('editLocal').value.trim();
    const novaEquipe = document.getElementById('editEquipe').value
                        .split(",")
                        .map(e => e.trim())
                        .filter(e => e);

    if (!novaCi || !novoServico || !novoLocal || !novaEquipe.length) {
        alert("Preencha todos os campos!");
        return;
    }

    // Atualiza atividadeAtual
    atividadeAtual.ci = novaCi;
    atividadeAtual.servico = novoServico;
    atividadeAtual.local = novoLocal;
    atividadeAtual.equipe = novaEquipe;

    fecharModal('modalEditarAtividade');

    // Atualiza modal de finalizar com os novos dados
    document.getElementById('detalhesServico').innerHTML =
        `CI: ${atividadeAtual.ci} | Servi√ßo: ${atividadeAtual.servico} | Local: ${atividadeAtual.local}<br>
         Equipe: ${atividadeAtual.equipe.join(", ")}`;

    // Reabre modal de finalizar
    abrirModal('modalFinalizar');

    mostrarToast("Atividade atualizada! Agora finalize o trabalho.");
}

// MODAL EQUIPE
function abrirEquipe() {
    abrirModal('modalEquipe'); // abre o modal
    atualizarEquipeCampo();    // atualiza a lista de atividades em andamento

    // FOR√áA o dropdown fechado
    const fOptions = document.getElementById('fOptions');
    fOptions.style.display = 'none';

    // Remove destaque de itens
    document.querySelectorAll('#fOptions .func-item').forEach(el => el.classList.remove('active'));

    // Reseta o texto do bot√£o
    document.getElementById('fDisplay').textContent = "Selecionar Equipe";

    // Limpa array selecionados
    selecionados = [];
}

function atualizarEquipeCampo(){
    const lista = document.getElementById('listaAndamento');
    lista.innerHTML = atividadesAtivas.length ? "" : "Nenhuma atividade em andamento.";

    // Cria um Set para armazenar funcion√°rios √∫nicos
    const funcionariosUnicos = new Set();

    atividadesAtivas.forEach((a,index)=>{
        // Adiciona cada membro da equipe no Set
        a.equipe.forEach(nome => funcionariosUnicos.add(nome));

        // COR POR SERVI√áO
       const serv = normalizar(a.servico);

const mapa = {
    pintura: { classe: "card-pintura", icone: "üé®" },
    eletrica: { classe: "card-eletrica", icone: "üí°" },
    hidraulica: { classe: "card-hidraulica", icone: "üö∞" },
    civil: { classe: "card-civil", icone: "üî®" }
};

const cfg = mapa[serv] || { classe: "", icone: "üõ†Ô∏è" };

let classeServico = cfg.classe;
let iconeServico = cfg.icone;
        // Cria card da atividade
        const card = document.createElement('div');
        card.className = `card-lista ${classeServico}`;
        card.innerHTML = `<strong>${iconeServico} CI ${a.ci}</strong><br>Servi√ßo: ${a.servico}<br>Local: ${a.local}<br>Equipe: ${a.equipe.join(", ")}`;
        card.onclick = ()=>prepararFinalizacao(index);

        lista.appendChild(card);
    });

    // Atualiza o badge com n√∫mero de funcion√°rios √∫nicos
    const badge = document.getElementById('badgeFuncionarios');
    if(funcionariosUnicos.size > 0){
        badge.textContent = funcionariosUnicos.size + " Funcion√°rio(s)";
        badge.style.display = 'block';
    } else {
        badge.style.display = 'none';
    }
}

// FINALIZAR
function prepararFinalizacao(idx){
    atividadeAtual = atividadesAtivas[idx];
    // ‚ùå remover o fechamento do modal de equipe
    // fecharModal('modalEquipe'); 
    abrirModal('modalFinalizar');
    document.getElementById('detalhesServico').innerHTML = 
        `CI: ${atividadeAtual.ci} | Servi√ßo: ${atividadeAtual.servico} | Local: ${atividadeAtual.local}<br>
         Equipe: ${atividadeAtual.equipe.join(", ")}`;
}
// FINALIZAR ATIVIDADE
function finalizarAtividade() {
    if (!atividadeAtual) return;

    const fotosInput = document.getElementById('fFotos');
    if (fotosInput.files.length === 0) {
        alert("√â obrigat√≥rio enviar pelo menos 1 foto!");
        return;
    }

    const fim = agoraISO();
    const relato = document.getElementById('fRelato').value || "-";

    const formData = new FormData();
    formData.append("idAtiva", atividadeAtual.id);
    formData.append("ci", atividadeAtual.ci);
    formData.append("servico", atividadeAtual.servico);
    formData.append("local", atividadeAtual.local);
    formData.append("equipe", atividadeAtual.equipe.join(",")); // string
    formData.append("inicio", atividadeAtual.inicio);
    formData.append("relato", relato);
    formData.append("fim", fim);

    // Adiciona arquivos
    Array.from(fotosInput.files).forEach(file => formData.append("fotos", file));


fetch(`${API_BASE}/atividades/finalizar`, { method: "POST", body: formData })
   .then(res => res.json())
.then(data => {

    if (!data.ok) throw new Error(data.error || "Erro backend");
        // Atualiza frontend
        atividadeAtual.fim = fim;
        atividadeAtual.relato = relato;
        atividadeAtual.fotos = data.fotos;

        atividadesConcluidas.push(atividadeAtual);
        atividadesAtivas = atividadesAtivas.filter(a => a !== atividadeAtual);

        fecharModal('modalFinalizar');
        mostrarToast("CI salva no banco!");

        document.getElementById('fRelato').value = "";
        document.getElementById('previewFotos').innerHTML = "";

        atualizarEquipeCampo();
        atualizarHistorico();

        if (atividadesAtivas.length === 0) {
            fecharModal('modalEquipe');
        }

        atividadeAtual = null;
    })
    .catch(err => {
        console.error(err);
        alert("Erro ao salvar atividade!");
    });
}
//Historico
function abrirHistorico(){

    abrirModal('modalHistorico');

   fetch(`${API_BASE}/atividades`)
        .then(r=>r.json())
        .then(data=>{
            atividadesConcluidas = data;
            atualizarHistorico();
        });
}// ATUALIZAR HIST√ìRICO COM FILTROS
// Fun√ß√£o atualizarHistorico agora respeita filtros
function atualizarHistorico() {
    const lista = document.getElementById('listaHistorico');
    lista.innerHTML = "";

    // Pega valores dos filtros
    const filtroDia = document.getElementById('filtroDiaHistorico').value;
    const filtroMes = document.getElementById('filtroMesHistorico').value;
    const filtroAno = document.getElementById('filtroAnoHistorico').value;
    const filtroServico = document.getElementById('filtroServicoHistorico').value;

    // Filtra atividades conclu√≠das
    let filtradas = atividadesConcluidas.filter(a => {
        let dataOk = true;
        const dataFim = new Date(a.fim);

        if (filtroDia) dataOk = dataOk && (dataFim.getDate() == parseInt(filtroDia));
        if (filtroMes) dataOk = dataOk && (dataFim.getMonth() + 1 == parseInt(filtroMes));
        if (filtroAno) dataOk = dataOk && (dataFim.getFullYear() == parseInt(filtroAno));

        const filtroServicoNormalizado = normalizar(filtroServico);
        let servicoOk = true;
        if (filtroServico) {
            servicoOk = normalizar(a.servico) === filtroServicoNormalizado;
        }

        return dataOk && servicoOk;
    });

    // ‚úÖ Ordena do mais recente para o mais antigo
    filtradas.sort((a, b) => new Date(b.fim) - new Date(a.fim));

    if (filtradas.length === 0) {
        lista.innerHTML = "Nenhuma CI finalizada.";
        return;
    }

    filtradas.forEach(a => {
        const serv = normalizar(a.servico);

        const mapa = {
            pintura: "card-pintura",
            eletrica: "card-eletrica",
            hidraulica: "card-hidraulica",
            civil: "card-civil"
        };

        const classeServico = mapa[serv] || "";

        const card = document.createElement('div');
        card.className = `card-lista card-concluido ${classeServico}`;

        // Adiciona fotos
       // NORMALIZA FOTOS (array ou string)
// ===============================
let fotos = [];

try {
    fotos = Array.isArray(a.fotos) ? a.fotos : JSON.parse(a.fotos || "[]");
} catch {
    fotos = [];
}

// Render fotos
let fotosHTML = '';

if (fotos.length > 0) {
    fotosHTML =
        `<div class="img-container">` +
        fotos.map((f,i) =>
            `<img src="${f}" class="img-preview"
             onclick="abrirImagemModal('${f}','CI-${a.ci}-foto${i+1}.jpg')">`
        ).join("") +
        `</div>`;
}

        card.innerHTML = `
            <strong>CI ${a.ci}</strong><br>
            Servi√ßo: ${a.servico}<br>
            Local: ${a.local}<br>
            Equipe: ${a.equipe.join(", ")}<br>
            In√≠cio: ${formatarBR(a.inicio)}<br>
            Fim: ${formatarBR(a.fim)}<br>
            Descri√ß√£o: ${a.relato}<br>
            ${fotosHTML}
        `;

        lista.appendChild(card);
    });
}
// PREVIEW DE IMAGENS
function previewImages(input){
    const preview=document.getElementById('previewFotos'); preview.innerHTML="";
    Array.from(input.files).forEach(file=>{
        const reader=new FileReader();
        reader.onload=e=>{
            const img=document.createElement("img");
            img.src=e.target.result; img.className="img-preview";
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
}

// RestaurarCi
async function restaurarCI() {

    const input = document.getElementById("restoreZip");
    const file = input.files[0];

    if (!file) return;

    const zip = await JSZip.loadAsync(file);

    const cis = [];

    for (const nome in zip.files) {

        if (!nome.endsWith(".txt")) continue;

        const txt = await zip.files[nome].async("string");

        try {
            const ci = JSON.parse(txt);
            cis.push(ci);
        } catch(e){
            console.error("CI inv√°lida:", nome);
        }
    }

    if (!cis.length) {
        alert("Nenhuma CI encontrada");
        return;
    }

    await fetch(`${API_BASE}/atividades/restaurar`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ cis })
    });

    alert("CIs restauradas com sucesso!");

    fecharModal("modalRestore");
    atualizarHistorico();
}


// TOAST
function mostrarToast(msg){ const t=document.getElementById('toastSucesso'); document.getElementById('toastTexto').textContent=msg; t.style.display='block'; t.classList.add('animar-entrada'); setTimeout(()=>t.style.display='none',2000); }

// MODAL DE IMAGEM
function abrirImagemModal(src, nome){
    imagemAtual = nome;
    const modal = document.getElementById('modalImagem');
    document.getElementById('imgGrande').src = src;
    modal.style.display = 'flex';
}
function baixarImagem(){
    const link = document.createElement('a');
    link.href = document.getElementById('imgGrande').src;
    link.download = imagemAtual || 'imagem.jpg';
    link.click();
}
carregarAtividades();
</script>
</body>
</html>
